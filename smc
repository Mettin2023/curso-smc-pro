import React, { useState, useEffect } from "react";
import { motion } from "framer-motion";

const curriculum = [
  {
    id: 1,
    title: "Fundamentos de Smart Money Concepts (SMC)",
    desc: "Introducción, conceptos clave y mentalidad",
    lessons: [
      { id: "1-1", title: "¿Qué es Smart Money Concepts?", minutes: 10 },
      { id: "1-2", title: "Terminología básica: BOS, CHoCH, OB, FVG", minutes: 18 },
      { id: "1-3", title: "Psicología y mentalidad del money flow", minutes: 12 },
    ],
  },
  {
    id: 2,
    title: "Herramientas y lectura de precio",
    desc: "Cómo leer la acción del precio y usar herramientas",
    lessons: [
      { id: "2-1", title: "Zonas de liquidez y niveles clave", minutes: 20 },
      { id: "2-2", title: "Order Blocks (OB) detectables", minutes: 22 },
      { id: "2-3", title: "Fair Value Gaps (FVG) y mitigaciones", minutes: 16 },
    ],
  },
  {
    id: 3,
    title: "Estrategias de entrada y gestión",
    desc: "Cómo planificar entradas, gestionar riesgo y RR",
    lessons: [
      { id: "3-1", title: "Confirmaciones con velas y estructuras", minutes: 25 },
      { id: "3-2", title: "Smart Entries: limit, market, stop logic", minutes: 20 },
      { id: "3-3", title: "Gestión del riesgo y tamaño de posición", minutes: 18 },
    ],
  },
  {
    id: 4,
    title: "De novato a pro: casos reales y práctica",
    desc: "Ejemplos en diferentes marcos temporales y mercados",
    lessons: [
      { id: "4-1", title: "Ejemplo en H4: identificar OB + entrada", minutes: 30 },
      { id: "4-2", title: "Ejemplo intradía M15: filtros y validaciones", minutes: 28 },
      { id: "4-3", title: "Backtesting y journaling efectivo", minutes: 24 },
    ],
  },
];

export default function CursoSMC() {
  const [selectedModule, setSelectedModule] = useState(curriculum[0]);
  const [selectedLesson, setSelectedLesson] = useState(curriculum[0].lessons[0]);
  const [query, setQuery] = useState("");
  const [completed, setCompleted] = useState(() => {
    try {
      return JSON.parse(localStorage.getItem("smc_completed_v1")) || {};
    } catch (e) {
      return {};
    }
  });

  useEffect(() => {
    localStorage.setItem("smc_completed_v1", JSON.stringify(completed));
  }, [completed]);

  function toggleComplete(lessonId) {
    setCompleted((prev) => ({ ...prev, [lessonId]: !prev[lessonId] }));
  }

  const filteredModules = curriculum.map((m) => ({
    ...m,
    lessons: m.lessons.filter((l) => l.title.toLowerCase().includes(query.toLowerCase())),
  }));

  const lessonContent = {
    "1-1": {
      title: "¿Qué es Smart Money Concepts?",
      text: `Smart Money Concepts (SMC) es un enfoque para leer cómo los participantes institucionales
      (el "dinero inteligente") mueven los precios. Se basa en identificar zonas donde estos participantes
      acumulan o distribuyen posiciones: Order Blocks (bloques de órdenes), Break of Structure (BOS),
      Change of Character (CHoCH), Fair Value Gaps (FVG) y zonas de liquidez. La idea central es alinear
      tu operativa con el flujo donde el precio tiene más probabilidades de ser movido por grandes jugadores.

      En este curso verás desde los conceptos básicos hasta cómo planear entradas, gestionar riesgo,
      y realizar backtests realistas.`,
      image: "/images/forex-intro.jpg"
    },
    "1-2": {
      title: "Terminología básica: BOS, CHoCH, OB, FVG",
      text: `- BOS (Break of Structure): ruptura de una estructura de precio que indica continuidad de tendencia.
      - CHoCH (Change of Character): cambio de carácter que sugiere posible reversión o indecisión.
      - Order Block: vela o conjunto de velas donde instituciones colocaron volumen y que sirve como zona de referencia.
      - FVG (Fair Value Gap): huecos en la estructura de precio que suelen atraer correcciones o mitigaciones.

      Aprender a identificar correctamente estos elementos es imprescindible antes de buscar entradas reales.`,
      image: "/images/smc-terminologia.png"
    },
    "2-1": {
      title: "Zonas de liquidez y niveles clave",
      text: `Las zonas de liquidez son áreas donde el precio tiende a buscar órdenes pendientes (stops, limit orders).
      Estas suelen ubicarse en máximos, mínimos o consolidaciones. Identificar estas zonas te ayudará a anticipar
      movimientos manipulativos del mercado.`,
      image: "/images/liquidez-forex.png"
    },
    "2-2": {
      title: "Order Blocks (OB) detectables",
      text: `Un Order Block es una vela fuerte (alcista o bajista) previa a un movimiento agresivo del mercado.
      Los OB representan huellas de instituciones. Una vez identificados, sirven como zonas de entrada o reacción.`,
      image: "/images/order-block.png"
    },
    "2-3": {
      title: "Fair Value Gaps (FVG) y mitigaciones",
      text: `Un FVG es un vacío en el precio entre velas consecutivas, generado por un desequilibrio de órdenes.
      El precio suele regresar a esa zona para "mitigarla" antes de continuar su tendencia.`,
      image: "/images/fvg-ejemplo.png"
    },
  };

  return (
    <div className="min-h-screen bg-slate-50 text-slate-900 p-6 md:p-12">
      <header className="max-w-6xl mx-auto mb-8">
        <div className="flex items-center justify-between">
          <div>
            <h1 className="text-3xl md:text-4xl font-extrabold">Curso completo de Smart Money Concepts (SMC)</h1>
            <p className="text-slate-600 mt-1">De novato a pro — todo explicado en español paso a paso</p>
          </div>
          <div className="text-right">
            <p className="text-sm text-slate-500">Progreso: {Object.values(completed).filter(Boolean).length} lecciones hechas</p>
          </div>
        </div>
      </header>

      <main className="max-w-6xl mx-auto grid grid-cols-1 md:grid-cols-4 gap-6">
        {/* Sidebar curriculum */}
        <aside className="md:col-span-1 bg-white rounded-2xl shadow p-4">
          <div className="mb-4">
            <input
              value={query}
              onChange={(e) => setQuery(e.target.value)}
              placeholder="Buscar lecciones..."
              className="w-full border rounded-md p-2 text-sm"
            />
          </div>

          <nav className="space-y-4">
            {filteredModules.map((m) => (
              <div key={m.id}>
                <button
                  onClick={() => { setSelectedModule(m); setSelectedLesson(m.lessons[0] || selectedLesson); }}
                  className={`w-full text-left p-2 rounded-md ${selectedModule.id === m.id ? 'bg-slate-100' : ''}`}
                >
                  <div className="flex justify-between items-center">
                    <div>
                      <h3 className="font-semibold">{m.title}</h3>
                      <p className="text-xs text-slate-500">{m.desc}</p>
                    </div>
                    <div className="text-xs text-slate-400">{m.lessons.length}</div>
                  </div>
                </button>

                <ul className="mt-2 ml-2 space-y-1">
                  {m.lessons.map((l) => (
                    <li key={l.id}>
                      <button
                        onClick={() => { setSelectedModule(m); setSelectedLesson(l); }}
                        className={`flex items-center justify-between w-full p-2 rounded-md text-sm ${selectedLesson.id === l.id ? 'bg-slate-100' : 'hover:bg-slate-50'}`}
                      >
                        <span>{l.title}</span>
                        <span className="text-xs text-slate-400">{l.minutes}m</span>
                      </button>
                    </li>
                  ))}
                </ul>
              </div>
            ))}
          </nav>
        </aside>

        {/* Main content */}
        <section className="md:col-span-3">
          <div className="bg-white rounded-2xl shadow p-6">
            <div className="flex items-start justify-between">
              <div>
                <h2 className="text-2xl font-bold">{selectedLesson.title}</h2>
                <p className="text-sm text-slate-500 mt-1">Módulo: {selectedModule.title}</p>
              </div>

              <div className="text-right">
                <button
                  onClick={() => toggleComplete(selectedLesson.id)}
                  className="px-4 py-2 rounded-xl border"
                >
                  {completed[selectedLesson.id] ? 'Marcar como no hecho' : 'Marcar como hecho'}
                </button>
              </div>
            </div>

            <hr className="my-4" />

            <article className="prose prose-slate max-w-none">
              {(lessonContent[selectedLesson.id] && (
                <>
                  <p>{lessonContent[selectedLesson.id].text}</p>
                  {lessonContent[selectedLesson.id].image && (
                    <img
                      src={lessonContent[selectedLesson.id].image}
                      alt={lessonContent[selectedLesson.id].title}
                      className="rounded-xl my-4 shadow"
                    />
                  )}
                </>
              )) || 'Contenido en construcción. Añade más lecciones desde el CMS o pide que te ayude a completar el temario.'}

              <section>
                <h3>Paso a paso: cómo identificar un Order Block (ejemplo)</h3>
                <ol>
                  <li>Observa la última estructura: ¿hubo BOS o CHoCH recientemente?</li>
                  <li>Busca velas con rango amplio y rechazo (mechas largas) que muestren fuerza institucional.</li>
                  <li>Marca la zona (alto-bajo) de esa vela como posible Order Block.</li>
                  <li>Confirma con zonas de liquidez y FVG cercanos antes de considerar entrada.</li>
                </ol>
              </section>

              <section>
                <h3>Ejercicios rápidos</h3>
                <ul>
                  <li>Busca 3 Order Blocks en un gráfico H4 y explica por qué los marcaste.</li>
                  <li>Identifica 2 FVG en gráfico M15 y su posible mitigación.</li>
                </ul>
              </section>
            </article>

            <div className="mt-6 grid grid-cols-1 md:grid-cols-3 gap-4">
              <div className="p-4 rounded-xl border">
                <h4 className="font-semibold">Recursos</h4>
                <ul className="text-sm text-slate-600 mt-2 space-y-1">
                  <li>Guía PDF descargable (próximamente)</li>
                  <li>Plantillas para TradingView</li>
                  <li>Checklist de entrada rápida</li>
                </ul>
              </div>

              <div className="p-4 rounded-xl border">
                <h4 className="font-semibold">Quiz rápido</h4>
                <p className="text-sm text-slate-600 mt-2">¿Qué es un FVG?</p>
                <div className="mt-2 flex gap-2">
                  <button className="px-3 py-2 rounded-md border text-sm">Hueco en la estructura</button>
                  <button className="px-3 py-2 rounded-md border text-sm">Indicador de volumen</button>
                </div>
              </div>

              <div className="p-4 rounded-xl border">
                <h4 className="font-semibold">Notas del instructor</h4>
                <p className="text-sm text-slate-600 mt-2">Consejos prácticos para no confundir OB con simples consolidaciones.</p>
              </div>
            </div>

          </div>

          <motion.div
            initial={{ opacity: 0, y: 20 }}
            animate={{ opacity: 1, y: 0 }}
            transition={{ delay: 0.12 }}
            className="mt-6 p-4 bg-white rounded-2xl shadow"
          >
            <h3 className="font-bold">Progreso del curso</h3>
            <p className="text-sm text-slate-500 mt-2">Guarda tu progreso en el navegador y retoma cuando quieras.</p>

            <div className="mt-4">
              <button
                onClick={() => {
                  setCompleted({});
                }}
                className="px-4 py-2 rounded-xl border"
              >
                Reiniciar progreso
              </button>
            </div>
          </motion.div>

        </section>
      </main>

      <footer className="max-w-6xl mx-auto mt-12 text-center text-slate-500 text-sm">
        <p>Creado con ❤️ — Si quieres que amplíe el temario, añadir ejercicios, imágenes o scripts para TradingView, dime y lo integro.</p>
      </footer>
    </div>
  );
}
